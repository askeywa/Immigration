# Nginx Configuration for Multi-Tenant Immigration Portal
# This configuration handles domain-based tenant routing

# Main server block for super admin (ibuyscrap.ca)
server {
    listen 80;
    listen 443 ssl;
    server_name ibuyscrap.ca www.ibuyscrap.ca;
    
    # SSL Configuration (you'll need to add your SSL certificates)
    ssl_certificate /etc/ssl/certs/ibuyscrap.ca.crt;
    ssl_certificate_key /etc/ssl/private/ibuyscrap.ca.key;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # Super Admin Frontend
    location / {
        proxy_pass http://localhost:5174;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Super Admin API
    location /api/ {
        proxy_pass http://localhost:5000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Tenant server block for honeynwild.com
server {
    listen 80;
    listen 443 ssl;
    server_name honeynwild.com www.honeynwild.com;
    
    # SSL Configuration (you'll need to add your SSL certificates)
    ssl_certificate /etc/ssl/certs/honeynwild.com.crt;
    ssl_certificate_key /etc/ssl/private/honeynwild.com.key;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # Tenant-specific API endpoints
    location /immigration-portal/api/ {
        proxy_pass http://localhost:5000/api/v1/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Add tenant context headers
        proxy_set_header X-Tenant-Domain honeynwild.com;
        proxy_set_header X-Tenant-Name "Honey & Wild Night Club";
    }
    
    # Tenant login page
    location /immigration-portal/login {
        alias /var/www/honeynwild.com/tenant-login.html;
        try_files $uri $uri/ =404;
    }
    
    # Tenant dashboard
    location /immigration-portal/dashboard {
        alias /var/www/honeynwild.com/tenant-dashboard.html;
        try_files $uri $uri/ =404;
    }
    
    # Default tenant frontend (if you want to serve a custom tenant frontend)
    location / {
        # For now, redirect to login page
        return 301 /immigration-portal/login;
    }
}

# Default server block (catch-all for unknown domains)
server {
    listen 80 default_server;
    listen 443 ssl default_server;
    server_name _;
    
    # SSL Configuration
    ssl_certificate /etc/ssl/certs/default.crt;
    ssl_certificate_key /etc/ssl/private/default.key;
    
    # Return 404 for unknown domains
    return 404;
}

# HTTP to HTTPS redirect
server {
    listen 80;
    server_name ibuyscrap.ca www.ibuyscrap.ca honeynwild.com www.honeynwild.com;
    return 301 https://$server_name$request_uri;
}
