name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      rollback_to_commit:
        description: 'Commit hash to rollback to (leave empty for previous deployment)'
        required: false
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for rollback
      
      - name: Rollback to Previous Commit
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        run: |
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          
          # Determine rollback target
          if [ -n "${{ github.event.inputs.rollback_to_commit }}" ]; then
            ROLLBACK_COMMIT="${{ github.event.inputs.rollback_to_commit }}"
            echo "Rolling back to specified commit: $ROLLBACK_COMMIT"
          else
            # Get the previous commit (before the current one)
            ROLLBACK_COMMIT=$(git log --oneline -2 | tail -1 | cut -d' ' -f1)
            echo "Rolling back to previous commit: $ROLLBACK_COMMIT"
          fi
          
          # Deploy to EC2 with rollback
          ssh -i private_key.pem -o StrictHostKeyChecking=no ${USER}@${HOST} '
            echo "🔄 Starting rollback deployment..."
            
            # Go to application directory
            cd /var/www/immigration-portal
            
            # Checkout the rollback commit
            echo "Checking out commit: '$ROLLBACK_COMMIT'"
            git fetch origin
            git reset --hard '$ROLLBACK_COMMIT'
            
            # Install dependencies and build
            echo "Installing dependencies..."
            cd backend && npm install
            cd ../frontend && npm install
            
            echo "Building applications..."
            cd ../backend && npm run build
            cd ../frontend && npm run build
            
            # Reload PM2 with zero downtime
            echo "Reloading application..."
            cd /var/www/immigration-portal/backend
            pm2 reload ecosystem.config.js --env production
            
            # Wait and verify health
            echo "Waiting for application to start..."
            sleep 10
            
            # Health check
            if curl -f http://localhost:5000/api/health > /dev/null 2>&1; then
              echo "✅ Rollback successful! Application is healthy."
            else
              echo "❌ Rollback failed! Application health check failed."
              pm2 logs immigration-portal --lines 20
              exit 1
            fi
            
            echo "🎉 Rollback completed successfully!"
          '
          
          rm -f private_key.pem
